# AWS Neuron Inf2 Dual Encoder with RoBERTa

AWS Inf2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ KLUE RoBERTa ëª¨ë¸ì„ ì‚¬ìš©í•œ ë“€ì–¼ ì¸ì½”ë” êµ¬í˜„ ë° ì‹œë§¨í‹± ê²€ìƒ‰ ë°ëª¨

## ğŸ“Œ í”„ë¡œì íŠ¸ ìš”ì•½

ì´ í”„ë¡œì íŠ¸ëŠ” AWS Inf2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ `klue/roberta-base` ëª¨ë¸ì„ Neuronìœ¼ë¡œ ì»´íŒŒì¼í•˜ì—¬ ì‹œë§¨í‹± ê²€ìƒ‰ì„ êµ¬í˜„í•˜ëŠ” ë°ëª¨ì…ë‹ˆë‹¤.

**ì£¼ìš” íŠ¹ì§•:**
- âœ… **ì™„ë²½í•œ ì¼ì¹˜ì„±**: HuggingFace ì›ë³¸ ëª¨ë¸ê³¼ Neuron ì»´íŒŒì¼ ëª¨ë¸ì´ ë™ì¼í•œ ê²°ê³¼ ìƒì„± (ì°¨ì´: 0.0000)
- ğŸš€ **ìµœì í™”ëœ ì¶”ë¡ **: AWS Neuron SDKë¥¼ í†µí•œ Inf2 í•˜ë“œì›¨ì–´ ê°€ì†í™”
- ğŸ§  **Mean Pooling**: í•™ìŠµë˜ì§€ ì•Šì€ pooler ëŒ€ì‹  mean poolingìœ¼ë¡œ ì˜ë¯¸ ìˆëŠ” ì„ë² ë”© ìƒì„±
- ğŸ“Š **ì‹œë§¨í‹± ê²€ìƒ‰**: í•œêµ­ì–´ ì¿¼ë¦¬-ë¬¸ì„œ ìœ ì‚¬ë„ ê³„ì‚° ë° ë­í‚¹

**í•µì‹¬ ê²°ê³¼:**
- ìœ ì‚¬ë„ ë²”ìœ„: 0.597 ~ 0.811 (ì˜ë¯¸ì  ì°¨ì´ ë°˜ì˜)
- ì¸ì½”ë”© ì†ë„: ~229ms (ë°°ì¹˜ í¬ê¸° 8)
- í•œêµ­ ìŒì‹ ê´€ë ¨ ë¬¸ì„œê°€ ë†’ì€ ìœ ì‚¬ë„ ì ìˆ˜ íšë“

**ë² ì´ìŠ¤ ëª¨ë¸:**
- **ëª¨ë¸ëª…**: klue/roberta-base
- **HuggingFace Hub**: https://huggingface.co/klue/roberta-base
- **íŒŒë¼ë¯¸í„°**: 111M | **ì–¸ì–´**: í•œêµ­ì–´

## ğŸ“‹ ëª©ì°¨

1. [Inf2 EC2 ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •](#inf2-ec2-ì¸ìŠ¤í„´ìŠ¤-ì„¤ì •)
2. [Docker í™˜ê²½ ì¤€ë¹„](#docker-í™˜ê²½-ì¤€ë¹„)
3. [ëª¨ë¸ ì»´íŒŒì¼](#ëª¨ë¸-ì»´íŒŒì¼)
4. [ì‹¤í–‰ í™˜ê²½](#ì‹¤í–‰-í™˜ê²½)
5. [í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰](#í…ŒìŠ¤íŠ¸-ì½”ë“œ-ì‹¤í–‰)
6. [ì‹¤í–‰ ê²°ê³¼](#ì‹¤í–‰-ê²°ê³¼)

## ğŸš€ Inf2 EC2 ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •

### 1. EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- [EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì°¸ì¡°](https://github.com/aws-samples/aws-ai-ml-workshop-kr/tree/master/neuron/vLLM/01-offline-inference_neuron)
  - **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…**: inf2.xlarge
  - **AMI**: Deep Learning AMI Neuron PyTorch (Ubuntu 22.04)
  - **ìŠ¤í† ë¦¬ì§€**: ìµœì†Œ 100GB
  - ![EC2 OS Image -AMI, ë° ì¸ìŠ¤í…‰ìŠ¤ íƒ€ì…](img/ami.jpg)

## ğŸ³ Docker í™˜ê²½ ì¤€ë¹„

### 1. Docker ì´ë¯¸ì§€ ì •ë³´

- **ë²„ì „**: v1.5-hf-tgi-3.3.4-pt-2.5.1-inf-neuronx-py310 (Sep 15, 2025)
- **GitHub ë¦´ë¦¬ì¦ˆ**: https://github.com/aws/deep-learning-containers/releases/tag/v1.5-hf-tgi-3.3.4-pt-2.5.1-inf-neuronx-py310

### 2. Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ

```bash
# ECR ë¡œê·¸ì¸
aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 763104351884.dkr.ecr.us-west-2.amazonaws.com

# ì´ë¯¸ì§€ í’€
docker pull 763104351884.dkr.ecr.us-west-2.amazonaws.com/huggingface-pytorch-tgi-inference:2.5.1-optimum3.3.4-neuronx-py310-ubuntu22.04-v1.5
```

### 3. Docker í™˜ê²½ í™•ì¸

```bash
# Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° í™˜ê²½ í™•ì¸
docker run -it --entrypoint /bin/bash 763104351884.dkr.ecr.us-west-2.amazonaws.com/huggingface-pytorch-tgi-inference:2.5.1-optimum3.3.4-neuronx-py310-ubuntu22.04-v1.5

# ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ optimum ë²„ì „ í™•ì¸
optimum-cli env
```
- ![optimum-clienv.jpg](img/optimum-cli-env.jpg)

## ğŸ”§ ëª¨ë¸ ì»´íŒŒì¼

### KLUE RoBERTa ëª¨ë¸ì„ Neuronìš©ìœ¼ë¡œ ì»´íŒŒì¼

```bash
# ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p ~/data

# ëª¨ë¸ ì»´íŒŒì¼ (Query Encoder)
time docker run --rm --entrypoint optimum-cli \
  -v $(pwd)/data:/data \
  --privileged \
  --memory=32g \
  --memory-swap=64g \
  763104351884.dkr.ecr.us-west-2.amazonaws.com/huggingface-pytorch-tgi-inference:2.5.1-optimum3.3.4-neuronx-py310-ubuntu22.04-v1.5 \
  export neuron \
  --model klue/roberta-base \
  --task feature-extraction \
  --batch_size 8 \
  --sequence_length 128 \
  --auto_cast_type fp16 \
  --num_cores 2 \
  /data/query-encoder-neuron
```

### ì»´íŒŒì¼ íŒŒë¼ë¯¸í„° ì„¤ëª…
- `--task feature-extraction`: ë¶„ë¥˜ê°€ ì•„ë‹Œ ì„ë² ë”© ì¶”ì¶œìš©
- `--batch_size 8`: ë°°ì¹˜ í¬ê¸° 8ë¡œ ê³ ì •
- `--sequence_length 128`: ìµœëŒ€ í† í° ê¸¸ì´
- `--auto_cast_type fp16`: FP16 ì •ë°€ë„ ì‚¬ìš©
- `--num_cores 2`: Neuron ì½”ì–´ 2ê°œ ì‚¬ìš©

## ğŸ’» ì‹¤í–‰ í™˜ê²½

### 1. ê°€ìƒí™˜ê²½ í™œì„±í™”

```bash
source /opt/aws_neuronx_venv_pytorch_2_8_nxd_inference/bin/activate
```

### 2. ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „

#### í•µì‹¬ Neuron/PyTorch:
- torch: 2.8.0
- torch-neuronx: 2.8.0.2.10.13553+1e4dd6ca
- torch-xla: 2.8.1
- torchvision: 0.23.0

#### Neuron ì»´íŒŒì¼ëŸ¬/ëŸ°íƒ€ì„:
- neuronx-cc: 2.21.18209.0+043b1bf7 (ì»´íŒŒì¼ëŸ¬)
- libneuronxla: 2.2.12677.0+470fa032
- neuronx-distributed: 0.15.22404+1f27bddf (ë¶„ì‚° í•™ìŠµ)
- neuronx-distributed-inference: 0.6.10598+a59fdc00

#### HuggingFace:
- transformers: 4.51.3
- huggingface-hub: 0.35.0
- sentencepiece: 0.2.1

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰

### 1. ì‹¤í–‰ ëª…ë ¹ì–´

```bash
source /opt/aws_neuronx_venv_pytorch_2_8_nxd_inference/bin/activate
cd /home/ubuntu/lab/14-robert-inf2
python test_dual_encoder.py
```

### 2. ë¹„êµ í…ŒìŠ¤íŠ¸ (HuggingFace vs Neuron)

```bash
python test_comparison_fixed.py
```

## ğŸ“Š ì‹¤í–‰ ê²°ê³¼

### 1. ëª¨ë¸ ë¹„êµ ê²°ê³¼

```
============================================================
Mean Pooling ë°©ì‹ ë¹„êµ (pooler ì‚¬ìš© ì•ˆí•¨)
============================================================

HuggingFace ëª¨ë¸ í…ŒìŠ¤íŠ¸
------------------------------------------------------------
ì¸ì½”ë”© ì‹œê°„: 181.8ms
ìœ ì‚¬ë„ ë²”ìœ„: 0.597 ~ 0.811
  1. [0.811] ê¹€ì¹˜ì°Œê°œì™€ ëœì¥ì°Œê°œëŠ” í•œêµ­ì˜ ëŒ€í‘œ ìŒì‹ì…ë‹ˆë‹¤....
  2. [0.758] ì¼ë³¸ ë¼ë©˜ê³¼ ì´ˆë°¥ì€ ì¸ê¸°ê°€ ë§ìŠµë‹ˆë‹¤....
  3. [0.737] ì„œìš¸ ê°•ë‚¨ì˜ ìœ ëª…í•œ í•œì‹ë‹¹ì„ ì†Œê°œí•©ë‹ˆë‹¤....

Neuron ëª¨ë¸ í…ŒìŠ¤íŠ¸
------------------------------------------------------------
ì¸ì½”ë”© ì‹œê°„: 224.2ms
ìœ ì‚¬ë„ ë²”ìœ„: 0.597 ~ 0.811
  1. [0.811] ê¹€ì¹˜ì°Œê°œì™€ ëœì¥ì°Œê°œëŠ” í•œêµ­ì˜ ëŒ€í‘œ ìŒì‹ì…ë‹ˆë‹¤....
  2. [0.758] ì¼ë³¸ ë¼ë©˜ê³¼ ì´ˆë°¥ì€ ì¸ê¸°ê°€ ë§ìŠµë‹ˆë‹¤....
  3. [0.737] ì„œìš¸ ê°•ë‚¨ì˜ ìœ ëª…í•œ í•œì‹ë‹¹ì„ ì†Œê°œí•©ë‹ˆë‹¤....

============================================================
ìœ ì‚¬ë„ ì°¨ì´ ë¹„êµ
------------------------------------------------------------
í‰ê·  ì°¨ì´: 0.0000
ìµœëŒ€ ì°¨ì´: 0.0000
```

### 2. ì‹œë§¨í‹± ê²€ìƒ‰ ê²°ê³¼

```
============================================================
ì¿¼ë¦¬: 'ë§›ìˆëŠ” í•œêµ­ ìŒì‹'
============================================================

ì¸ì½”ë”© ì‹œê°„: 229.0ms

ìœ ì‚¬ë„ ê²°ê³¼:
------------------------------------------------------------
1. [0.811] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   ê¹€ì¹˜ì°Œê°œì™€ ëœì¥ì°Œê°œëŠ” í•œêµ­ì˜ ëŒ€í‘œ ìŒì‹ì…ë‹ˆë‹¤.

2. [0.737] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   ì„œìš¸ ê°•ë‚¨ì˜ ìœ ëª…í•œ í•œì‹ë‹¹ì„ ì†Œê°œí•©ë‹ˆë‹¤.

3. [0.758] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   ì¼ë³¸ ë¼ë©˜ê³¼ ì´ˆë°¥ì€ ì¸ê¸°ê°€ ë§ìŠµë‹ˆë‹¤.

============================================================
ìƒìœ„ 3ê°œ ë¬¸ì„œ:
  1. [0.811] ê¹€ì¹˜ì°Œê°œì™€ ëœì¥ì°Œê°œëŠ” í•œêµ­ì˜ ëŒ€í‘œ ìŒì‹ì…ë‹ˆë‹¤.
  2. [0.758] ì¼ë³¸ ë¼ë©˜ê³¼ ì´ˆë°¥ì€ ì¸ê¸°ê°€ ë§ìŠµë‹ˆë‹¤.
  3. [0.737] ì„œìš¸ ê°•ë‚¨ì˜ ìœ ëª…í•œ í•œì‹ë‹¹ì„ ì†Œê°œí•©ë‹ˆë‹¤.
```

## ğŸ” ì£¼ìš” íŠ¹ì§•

### 1. ì™„ë²½í•œ ëª¨ë¸ ì¼ì¹˜ì„±
- HuggingFace ì›ë³¸ ëª¨ë¸ê³¼ Neuron ì»´íŒŒì¼ ëª¨ë¸ì´ **ì™„ì „íˆ ë™ì¼í•œ ê²°ê³¼** ìƒì„±
- í‰ê·  ì°¨ì´: 0.0000, ìµœëŒ€ ì°¨ì´: 0.0000

### 2. ì˜ë¯¸ì  ìœ ì‚¬ë„ ë¶„ì„
- Mean Pooling ë°©ì‹ ì‚¬ìš©ìœ¼ë¡œ ì˜ë¯¸ ìˆëŠ” ìœ ì‚¬ë„ ê³„ì‚°
- ìœ ì‚¬ë„ ë²”ìœ„: 0.597 ~ 0.811ë¡œ ë¬¸ì„œ ê°„ ì˜ë¯¸ì  ì°¨ì´ ë°˜ì˜
- í•œêµ­ ìŒì‹ ê´€ë ¨ ë¬¸ì„œê°€ ë†’ì€ ìœ ì‚¬ë„ ì ìˆ˜ íšë“

### 3. ì„±ëŠ¥
- Neuron ëª¨ë¸ ì¸ì½”ë”© ì‹œê°„: ~229ms
- HuggingFace ëª¨ë¸ ì¸ì½”ë”© ì‹œê°„: ~182ms
- ë°°ì¹˜ í¬ê¸° 8ë¡œ ìµœì í™”ëœ ì²˜ë¦¬ëŸ‰

## ğŸ“ ì£¼ì˜ì‚¬í•­

1. **Pooler ì‚¬ìš© ê¸ˆì§€**: `klue/roberta-base`ì˜ poolerëŠ” í•™ìŠµë˜ì§€ ì•Šì•„ Mean Pooling ì‚¬ìš© í•„ìˆ˜
2. **ë°°ì¹˜ í¬ê¸° ê³ ì •**: ì»´íŒŒì¼ ì‹œ ì„¤ì •í•œ ë°°ì¹˜ í¬ê¸°(8)ë¡œ ê³ ì •
3. **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê²½ê³ **: Neuron Runtime ì¢…ë£Œ ì‹œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê²½ê³  ë°œìƒ (ì •ìƒì ì¸ í˜„ìƒ)

## ğŸ› ì•Œë ¤ì§„ ì´ìŠˆ

- `nrtucode: internal error: 54 object(s) leaked, improper teardown`: Neuron Runtime ì •ë¦¬ ì‹œ ë°œìƒí•˜ëŠ” ë¬´í•´í•œ ì—ëŸ¬
- Pooler weight ì´ˆê¸°í™” ê²½ê³ : í•™ìŠµë˜ì§€ ì•Šì€ pooler layerë¡œ ì¸í•œ ì •ìƒì ì¸ ê²½ê³ 